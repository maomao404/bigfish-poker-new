<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>BIGFISH POKER</title>
    <style>
        :root {
            --color-canvas-default: #ffffff;
            --color-canvas-subtle: #f6f8fa;
            --color-border-default: #d0d7de;
            --color-border-muted: #d8dee4;
            --color-accent-fg: #0969da;
            --color-accent-emphasis: #0969da;
            --color-danger-fg: #cf222e;
            --color-primer-shadow-inset: inset 0 1px 0 rgba(208,215,222,0.2);
            --color-primer-shadow-focus: 0 0 0 3px rgba(9,105,218,0.3);
            --color-fg-default: #24292f;
            --color-fg-muted: #57606a;
            --max-width-mobile: 100%;
            --max-width-desktop: 1000px;
            --padding-mobile: 12px;
            --padding-desktop: 20px;
        }

        body {
            max-width: var(--max-width-mobile);
            padding: var(--padding-mobile);
            margin: 0 auto;
            font-size: 14px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif;
            line-height: 1.5;
            color: var(--color-fg-default);
            background-color: var(--color-canvas-subtle);
        }

        /* Logo 和标题样式 */
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 16px auto;
            height: 40px;
        }

        .fish-logo {
            width: 32px;
            height: 32px;
            position: relative;
            transform: rotate(-45deg);
            display: inline-block;
        }

        .fish-body {
            width: 100%;
            height: 100%;
            background: var(--color-accent-fg);
            border-radius: 50% 50% 50% 0;
            position: relative;
            animation: swim 3s ease-in-out infinite;
        }

        .fish-tail {
            position: absolute;
            width: 40%;
            height: 40%;
            background: var(--color-accent-fg);
            bottom: -10%;
            right: -10%;
            border-radius: 50% 0 50% 50%;
            transform: rotate(45deg);
        }

        .fish-eye {
            position: absolute;
            width: 20%;
            height: 20%;
            background: white;
            border-radius: 50%;
            top: 30%;
            left: 30%;
            border: 2px solid var(--color-canvas-default);
        }

        @keyframes swim {
            0%, 100% {
                transform: rotate(-45deg) translateY(0);
            }
            50% {
                transform: rotate(-45deg) translateY(-5px);
            }
        }

        .site-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--color-accent-fg);
            margin: 0;
            padding: 0;
            line-height: 40px;
            display: inline-block;
            vertical-align: middle;
        }

        /* 结果显示样式 */
        .result-card {
            background-color: var(--color-canvas-default);
            border: 1px solid var(--color-border-default);
            border-radius: 6px;
            padding: 16px;
            margin-top: 16px;
        }

        .result-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--color-border-muted);
        }

        .result-title {
            color: var(--color-fg-default);
            font-size: 16px;
            font-weight: 600;
            margin: 0;
        }

        .win-rate {
            display: flex;
            align-items: center;
            gap: 24px;
            margin-bottom: 16px;
        }

        .win-rate-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 8px solid var(--color-accent-fg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 600;
            color: var(--color-accent-fg);
            background: var(--color-canvas-subtle);
        }

        .win-rate-details {
            flex: 1;
        }

        .stat-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 6px;
            background: var(--color-canvas-subtle);
        }

        .stat-label {
            color: var(--color-fg-muted);
            font-size: 14px;
            margin-right: 16px;
            min-width: 100px;
        }

        .stat-value {
            color: var(--color-fg-default);
            font-weight: 600;
        }

        .stat-value.positive {
            color: var(--color-accent-fg);
        }

        .stat-value.negative {
            color: var(--color-danger-fg);
        }

        .progress-bar {
            height: 8px;
            background: var(--color-canvas-subtle);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 4px;
        }

        .progress-fill {
            height: 100%;
            background: var(--color-accent-fg);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* 图表容器样式 */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin: 20px 0;
        }

        #handTypeChart {
            background-color: white;
        }

        /* 底池赔率计算器样式 */
        .calculator-section {
            background-color: var(--color-canvas-default);
            border: 1px solid var(--color-border-default);
            border-radius: 6px;
            padding: 16px;
            margin-top: 24px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--color-border-muted);
        }

        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .input-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-field label {
            color: var(--color-fg-muted);
            font-size: 14px;
            font-weight: 500;
        }

        .odds-result {
            background: var(--color-canvas-subtle);
            border-radius: 6px;
            padding: 16px;
            margin-top: 16px;
        }

        .odds-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .odds-item {
            background: var(--color-canvas-default);
            border: 1px solid var(--color-border-muted);
            border-radius: 6px;
            padding: 12px;
            text-align: center;
        }

        /* 牌选择器样式 */
        .card-selector-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .card-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
            flex-wrap: nowrap;
        }

        .card-selector label {
            white-space: nowrap;
            font-size: 14px;
            color: var(--color-fg-muted);
            min-width: 70px;
        }

        .card-selector select {
            padding: 6px 12px;
            border: 1px solid var(--color-border-default);
            border-radius: 6px;
            background-color: var(--color-canvas-default);
            color: var(--color-fg-default);
            font-size: 14px;
            min-width: 80px;
        }

        /* 公共牌样式 */
        .community-cards {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 16px;
        }

        .card-group {
            background: var(--color-canvas-subtle);
            padding: 16px;
            border-radius: 6px;
        }

        .card-group h4 {
            margin: 0 0 12px 0;
            color: var(--color-fg-muted);
            font-size: 14px;
            font-weight: 600;
        }

        .card-select {
            padding: 6px 10px;
            min-width: 70px;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .logo-container {
                height: 32px;
            }
            
            .fish-logo {
                width: 24px;
                height: 24px;
            }
            
            .site-title {
                font-size: 1.4rem;
                line-height: 32px;
            }

            .win-rate {
                flex-direction: column;
                align-items: center;
                gap: 16px;
            }

            .win-rate-circle {
                width: 100px;
                height: 100px;
                font-size: 20px;
                border-width: 6px;
            }

            .stat-item {
                padding: 6px;
            }

            .stat-label {
                min-width: 80px;
                font-size: 13px;
            }

            .card-selector {
                gap: 4px;
            }

            .card-selector label {
                min-width: 60px;
                font-size: 13px;
            }

            .card-selector select {
                padding: 6px 8px;
                min-width: 60px;
            }

            .chart-container {
                height: 250px;
                padding: 12px;
            }
        }

        /* 暗色模式支持 */
        @media (prefers-color-scheme: dark) {
            :root {
                --color-canvas-default: #0d1117;
                --color-canvas-subtle: #161b22;
                --color-border-default: #30363d;
                --color-border-muted: #21262d;
                --color-fg-default: #c9d1d9;
                --color-fg-muted: #8b949e;
                --color-accent-fg: #58a6ff;
            }

            body {
                background-color: var(--color-canvas-default);
                color: var(--color-fg-default);
            }
        }

        /* 按钮样式 */
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .primary-button {
            background-color: var(--color-accent-fg);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .primary-button:hover {
            background-color: var(--color-accent-emphasis);
        }

        .secondary-button {
            background-color: var(--color-canvas-default);
            color: var(--color-fg-default);
            border: 1px solid var(--color-border-default);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .secondary-button:hover {
            background-color: var(--color-canvas-subtle);
        }

        /* 禁用状态 */
        .primary-button:disabled,
        .secondary-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 16px;
        }

        .stats-card {
            background: var(--color-canvas-default);
            border: 1px solid var(--color-border-default);
            border-radius: 6px;
            padding: 16px;
        }

        .stats-card h4 {
            margin: 0 0 16px 0;
            color: var(--color-fg-default);
            font-size: 14px;
            font-weight: 600;
        }

        .stats-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .stat-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .stat-label {
            min-width: 80px;
            font-size: 13px;
            color: var(--color-fg-muted);
        }

        .stat-bar-container {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-bar {
            height: 8px;
            background: var(--color-accent-fg);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .stat-value {
            font-size: 13px;
            color: var(--color-fg-default);
            min-width: 40px;
            text-align: right;
        }

        .position-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .position-value {
            background: var(--color-canvas-subtle);
            border-radius: 6px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .position-label {
            font-size: 13px;
            color: var(--color-fg-muted);
        }

        .position-score {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-accent-fg);
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .position-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .history-container {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            background: var(--color-canvas-subtle);
            border: 1px solid var(--color-border-default);
            border-radius: 6px;
            margin-bottom: 10px;
            padding: 12px;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .history-time {
            color: var(--color-fg-muted);
            font-size: 0.9em;
        }

        .history-equity {
            font-weight: bold;
            color: var(--color-accent-fg);
        }

        .history-cards {
            margin-bottom: 8px;
        }

        .hole-cards, .board-cards {
            display: block;
            margin-bottom: 4px;
        }

        .history-actions {
            display: flex;
            gap: 8px;
        }

        .history-actions button {
            padding: 4px 8px;
            font-size: 0.9em;
        }

        .chart-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 20px 0;
        }

        #handTypeChart {
            width: 100% !important;
            height: 100% !important;
        }

        #suggestion pre {
            margin: 0;
            white-space: pre-wrap;
            font-family: inherit;
            color: inherit;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="logo-container">
        <div class="fish-logo">
            <div class="fish-body">
                <div class="fish-eye"></div>
                <div class="fish-tail"></div>
            </div>
        </div>
        <h1 class="site-title">BIGFISH POKER</h1>
    </div>

    <div class="calculator-section">
        <div class="section-header">
            <h3>手牌选择</h3>
        </div>
        
        <div class="card-selector-group">
            <!-- 手牌选择 -->
            <div class="card-selector">
                <label>第一张牌</label>
                <select id="card1Rank">
                    <option value="">选择点数</option>
                    <option value="A">A</option>
                    <option value="K">K</option>
                    <option value="Q">Q</option>
                    <option value="J">J</option>
                    <option value="T">10</option>
                    <option value="9">9</option>
                    <option value="8">8</option>
                    <option value="7">7</option>
                    <option value="6">6</option>
                    <option value="5">5</option>
                    <option value="4">4</option>
                    <option value="3">3</option>
                    <option value="2">2</option>
                </select>
                <select id="card1Suit">
                    <option value="">选择花色</option>
                    <option value="h">♥</option>
                    <option value="s">♠</option>
                    <option value="d">♦</option>
                    <option value="c">♣</option>
                </select>
            </div>

            <div class="card-selector">
                <label>第二张牌</label>
                <select id="card2Rank">
                    <option value="">选择点数</option>
                    <option value="A">A</option>
                    <option value="K">K</option>
                    <option value="Q">Q</option>
                    <option value="J">J</option>
                    <option value="T">10</option>
                    <option value="9">9</option>
                    <option value="8">8</option>
                    <option value="7">7</option>
                    <option value="6">6</option>
                    <option value="5">5</option>
                    <option value="4">4</option>
                    <option value="3">3</option>
                    <option value="2">2</option>
                </select>
                <select id="card2Suit">
                    <option value="">选择花色</option>
                    <option value="h">♥</option>
                    <option value="s">♠</option>
                    <option value="d">♦</option>
                    <option value="c">♣</option>
                </select>
            </div>
        </div>

        <!-- 公共牌选择 -->
        <div class="section-header">
            <h3>公共牌</h3>
        </div>
        
        <div class="community-cards">
            <div class="card-group">
                <h4>翻牌</h4>
                <div class="card-selector">
                    <select id="flop1Rank" class="card-select">
                        <option value="">点数</option>
                        <!-- 与上面相同的点数选项 -->
                    </select>
                    <select id="flop1Suit" class="card-select">
                        <option value="">花色</option>
                        <!-- 与上面相同的花色选项 -->
                    </select>
                </div>
                <div class="card-selector">
                    <select id="flop2Rank" class="card-select">
                        <option value="">点数</option>
                    </select>
                    <select id="flop2Suit" class="card-select">
                        <option value="">花色</option>
                    </select>
                </div>
                <div class="card-selector">
                    <select id="flop3Rank" class="card-select">
                        <option value="">点数</option>
                    </select>
                    <select id="flop3Suit" class="card-select">
                        <option value="">花色</option>
                    </select>
                </div>
            </div>
            
            <div class="card-group">
                <h4>转牌</h4>
                <div class="card-selector">
                    <select id="turnRank" class="card-select">
                        <option value="">点数</option>
                    </select>
                    <select id="turnSuit" class="card-select">
                        <option value="">花色</option>
                    </select>
                </div>
            </div>
            
            <div class="card-group">
                <h4>河牌</h4>
                <div class="card-selector">
                    <select id="riverRank" class="card-select">
                        <option value="">点数</option>
                    </select>
                    <select id="riverSuit" class="card-select">
                        <option value="">花色</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- 在公共牌选择区域后添加胜率计算按钮和结果显示 -->
        <div class="action-buttons">
            <button id="calculateButton" class="primary-button" onclick="calculateAndUpdateEquity()">计算胜率</button>
            <button id="clearButton" class="secondary-button" onclick="clearCards()">清空选择</button>
        </div>
    </div>

    <div id="result" class="result-card">
        <div class="result-header">
            <h3 class="result-title">胜率分析结果</h3>
            <span class="stat-value">更新时间: <span id="updateTime"></span></span>
        </div>
        
        <div class="win-rate">
            <div class="win-rate-circle">
                <span id="mainWinRate">0%</span>
            </div>
            <div class="win-rate-details">
                <div class="stat-item">
                    <span class="stat-label">胜率</span>
                    <div style="flex: 1;">
                        <span class="stat-value positive">0%</span>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="stat-item">
                    <span class="stat-label">平局概率</span>
                    <div style="flex: 1;">
                        <span class="stat-value">0%</span>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="stat-item">
                    <span class="stat-label">失败概率</span>
                    <div style="flex: 1;">
                        <span class="stat-value negative">100%</span>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 100%; background: var(--color-danger-fg)"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="stat-item">
            <span class="stat-label">建议操作</span>
            <span class="stat-value" id="suggestion">请选择手牌</span>
        </div>
    </div>

    <div class="calculator-section">
        <div class="section-header">
            <h3>底池赔率计算器</h3>
        </div>
        
        <div class="input-group">
            <div class="input-field">
                <label for="potSize">当前底池</label>
                <input type="number" id="potSize" min="0" step="1">
            </div>
            <div class="input-field">
                <label for="betSize">需要跟注</label>
                <input type="number" id="betSize" min="0" step="1">
            </div>
        </div>
        
        <button onclick="calculatePotOdds()">计算赔率</button>
        
        <div id="oddsResult" class="odds-result" style="display: none;">
            <div class="odds-grid">
                <div class="odds-item">
                    <div class="odds-label">底池赔率</div>
                    <div class="odds-value" id="potOdds">--</div>
                </div>
                <div class="odds-item">
                    <div class="odds-label">所需胜率</div>
                    <div class="odds-value" id="requiredEquity">--</div>
                </div>
                <div class="odds-item">
                    <div class="odds-label">投资回报率</div>
                    <div class="odds-value" id="roi">--</div>
                </div>
            </div>
        </div>
    </div>

    <div class="calculator-section">
        <div class="section-header">
            <h3>对手范围分析</h3>
        </div>
        
        <div class="input-group">
            <div class="input-field">
                <label for="opponentPosition">对手位置</label>
                <select id="opponentPosition">
                    <option value="UTG">UTG</option>
                    <option value="MP">MP</option>
                    <option value="CO">CO</option>
                    <option value="BTN">BTN</option>
                    <option value="SB">SB</option>
                    <option value="BB">BB</option>
                </select>
            </div>
            <div class="input-field">
                <label for="opponentAction">对手行动</label>
                <select id="opponentAction">
                    <option value="raise">加注</option>
                    <option value="call">跟注</option>
                    <option value="3bet">3bet</option>
                    <option value="4bet">4bet</option>
                </select>
            </div>
            <div class="input-field">
                <label for="analyzeStreet">分析街道</label>
                <select id="analyzeStreet">
                    <option value="preflop">翻牌前</option>
                    <option value="flop">翻牌圈</option>
                    <option value="turn">转牌</option>
                    <option value="river">河牌</option>
                </select>
            </div>
        </div>
        
        <button onclick="analyzeOpponentRange()">分析范围</button>
        
        <div id="rangeAnalysisResult" class="odds-result" style="display: none;">
            <div class="range-summary">
                <div class="odds-item">
                    <div class="odds-label">预测范围强度</div>
                    <div class="odds-value" id="rangeStrength">--</div>
                </div>
                <div class="odds-item">
                    <div class="odds-label">关键牌型</div>
                    <div class="odds-value" id="keyHands">--</div>
                </div>
            </div>
            <div class="range-suggestion">
                <h4>策略建议</h4>
                <p id="rangeSuggestion">--</p>
            </div>
        </div>
    </div>

    <div class="calculator-section">
        <div class="section-header">
            <h3>牌型分布统计</h3>
        </div>
        <div class="chart-container" style="position: relative; height:300px; width:100%">
            <canvas id="handTypeChart"></canvas>
        </div>
    </div>

    <div class="calculator-section">
        <div class="section-header">
            <h3>详细统计分析</h3>
        </div>

        <div class="stats-grid">
            <!-- 手牌分类 -->
            <div class="stats-card">
                <h4>手牌分类</h4>
                <div class="stats-content">
                    <div class="stat-row">
                        <span class="stat-label">高牌</span>
                        <div class="stat-bar-container">
                            <div class="stat-bar" id="highCardBar" style="width: 0%"></div>
                            <span class="stat-value" id="highCardValue">0%</span>
                        </div>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">成对</span>
                        <div class="stat-bar-container">
                            <div class="stat-bar" id="pairBar" style="width: 0%"></div>
                            <span class="stat-value" id="pairValue">0%</span>
                        </div>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">连牌</span>
                        <div class="stat-bar-container">
                            <div class="stat-bar" id="connectorBar" style="width: 0%"></div>
                            <span class="stat-value" id="connectorValue">0%</span>
                        </div>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">同花</span>
                        <div class="stat-bar-container">
                            <div class="stat-bar" id="suitedBar" style="width: 0%"></div>
                            <span class="stat-value" id="suitedValue">0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 潜力分析 -->
            <div class="stats-card">
                <h4>成牌潜力</h4>
                <div class="stats-content">
                    <div class="stat-row">
                        <span class="stat-label">顺子潜力</span>
                        <div class="stat-bar-container">
                            <div class="stat-bar" id="straightDrawBar" style="width: 0%"></div>
                            <span class="stat-value" id="straightDrawValue">0%</span>
                        </div>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">同花潜力</span>
                        <div class="stat-bar-container">
                            <div class="stat-bar" id="flushDrawBar" style="width: 0%"></div>
                            <span class="stat-value" id="flushDrawValue">0%</span>
                        </div>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">超对潜力</span>
                        <div class="stat-bar-container">
                            <div class="stat-bar" id="overPairBar" style="width: 0%"></div>
                            <span class="stat-value" id="overPairValue">0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 位置价值 -->
            <div class="stats-card">
                <h4>位置价值</h4>
                <div class="position-grid">
                    <div class="position-value" id="btnValue">
                        <span class="position-label">BTN</span>
                        <span class="position-score">85%</span>
                    </div>
                    <div class="position-value" id="coValue">
                        <span class="position-label">CO</span>
                        <span class="position-score">75%</span>
                    </div>
                    <div class="position-value" id="mpValue">
                        <span class="position-label">MP</span>
                        <span class="position-score">65%</span>
                    </div>
                    <div class="position-value" id="utgValue">
                        <span class="position-label">UTG</span>
                        <span class="position-score">55%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="calculator-section">
        <div class="section-header">
            <h3>历史记录</h3>
        </div>
        
        <div class="history-container">
            <div class="history-list" id="historyList">
                <!-- 历史记录将在这里动态显示 -->
            </div>
        </div>
    </div>

    <script>
        // 预设的起始手牌胜率表（169种组合）
        const startingHandEquity = {
            // 口袋对
            'AA': 85.2, 'KK': 82.4, 'QQ': 79.9, 'JJ': 77.5,
            'TT': 75.1, '99': 72.1, '88': 69.1, '77': 66.2,
            '66': 63.3, '55': 60.3, '44': 57.4, '33': 54.6, '22': 51.7,
            
            // AK - A2
            'AKs': 67.0, 'AQs': 66.1, 'AJs': 65.1, 'ATs': 64.1,
            'A9s': 62.8, 'A8s': 61.8, 'A7s': 60.9, 'A6s': 59.9,
            'A5s': 60.5, 'A4s': 59.5, 'A3s': 58.5, 'A2s': 57.6,
            
            'AKo': 65.4, 'AQo': 64.5, 'AJo': 63.5, 'ATo': 62.5,
            'A9o': 60.9, 'A8o': 59.9, 'A7o': 59.0, 'A6o': 58.0,
            'A5o': 58.6, 'A4o': 57.6, 'A3o': 56.6, 'A2o': 55.7,
            
            // KQ - K2
            'KQs': 63.4, 'KJs': 62.5, 'KTs': 61.6,
            'K9s': 59.9, 'K8s': 58.7, 'K7s': 57.8,
            'K6s': 56.9, 'K5s': 56.0, 'K4s': 55.1,
            'K3s': 54.2, 'K2s': 53.3,
            
            'KQo': 61.8, 'KJo': 60.9, 'KTo': 60.0,
            'K9o': 58.0, 'K8o': 56.8, 'K7o': 55.9,
            'K6o': 55.0, 'K5o': 54.1, 'K4o': 53.2,
            'K3o': 52.3, 'K2o': 51.4,
            
            // QJ - Q2
            'QJs': 60.3, 'QTs': 59.4, 'Q9s': 57.7,
            'Q8s': 56.5, 'Q7s': 55.3, 'Q6s': 54.4,
            'Q5s': 53.5, 'Q4s': 52.6, 'Q3s': 51.7,
            'Q2s': 50.8,
            
            'QJo': 58.7, 'QTo': 57.8, 'Q9o': 55.8,
            'Q8o': 54.6, 'Q7o': 53.4, 'Q6o': 52.5,
            'Q5o': 51.6, 'Q4o': 50.7, 'Q3o': 49.8,
            'Q2o': 48.9,
            
            // 连牌
            'JTs': 57.5, 'T9s': 55.6, '98s': 53.8,
            '87s': 51.9, '76s': 50.0, '65s': 48.1,
            '54s': 46.2, '43s': 44.3, '32s': 42.4,
            
            'JTo': 55.9, 'T9o': 54.0, '98o': 52.2,
            '87o': 50.3, '76o': 48.4, '65o': 46.5,
            '54o': 44.6, '43o': 42.7, '32o': 40.8
        };

        // 计算手牌强度
        function calculateHandStrength(hand) {
            // 获取起始手牌代码
            const handCode = getStartingHandCode(hand.hand[0], hand.hand[1]);
            let equity = startingHandEquity[handCode] || 45.0;

            // 如果有公共牌，调整胜率
            if (hand.board.length > 0) {
                equity = adjustEquityWithBoard(hand);
            }

            console.log('Hand code:', handCode, 'Equity:', equity); // 调试日志
            return Math.round(equity);
        }

        // 根据公共牌调整胜率
        function adjustEquityWithBoard(hand) {
            let equity = 50;
            const handRanking = evaluateHand([...hand.hand, ...hand.board]);
            
            switch(handRanking) {
                case 'straightFlush': equity = 95; break;
                case 'fourOfAKind': equity = 90; break;
                case 'fullHouse': equity = 85; break;
                case 'flush': equity = 80; break;
                case 'straight': equity = 75; break;
                case 'threeOfAKind': equity = 70; break;
                case 'twoPair': equity = 65; break;
                case 'pair': equity = 60; break;
                default: equity = 45;
            }

            // 根据公共牌数量调整
            const boardCount = hand.board.length;
            if (boardCount === 3) equity *= 0.95;
            if (boardCount === 4) equity *= 0.9;
            if (boardCount === 5) equity *= 0.85;

            return equity;
        }

        // 评估牌型
        function evaluateHand(cards) {
            // 统计点数和花色
            const rankCount = {};
            const suitCount = {};
            
            cards.forEach(card => {
                rankCount[card.rank] = (rankCount[card.rank] || 0) + 1;
                suitCount[card.suit] = (suitCount[card.suit] || 0) + 1;
            });

            // 检查各种牌型
            if (hasStraightFlush(cards)) return 'straightFlush';
            if (hasFourOfAKind(rankCount)) return 'fourOfAKind';
            if (hasFullHouse(rankCount)) return 'fullHouse';
            if (hasFlush(suitCount)) return 'flush';
            if (hasStraight(cards)) return 'straight';
            if (hasThreeOfAKind(rankCount)) return 'threeOfAKind';
            if (hasTwoPair(rankCount)) return 'twoPair';
            if (hasPair(rankCount)) return 'pair';
            return 'highCard';
        }

        // 各种牌型检查函数
        function hasStraightFlush(cards) {
            return hasFlush({[cards[0].suit]: 5}) && hasStraight(cards);
        }

        function hasFourOfAKind(rankCount) {
            return Object.values(rankCount).some(count => count === 4);
        }

        function hasFullHouse(rankCount) {
            const counts = Object.values(rankCount);
            return counts.includes(3) && counts.includes(2);
        }

        function hasFlush(suitCount) {
            return Object.values(suitCount).some(count => count >= 5);
        }

        function hasStraight(cards) {
            const ranks = 'A23456789TJQKA';
            const distinctRanks = [...new Set(cards.map(c => c.rank))].sort(
                (a, b) => ranks.indexOf(a) - ranks.indexOf(b)
            );
            for (let i = 0; i <= distinctRanks.length - 5; i++) {
                const straight = distinctRanks.slice(i, i + 5);
                const straightStr = straight.join('');
                if (ranks.includes(straightStr)) return true;
            }
            return false;
        }

        function hasThreeOfAKind(rankCount) {
            return Object.values(rankCount).some(count => count === 3);
        }

        function hasTwoPair(rankCount) {
            return Object.values(rankCount).filter(count => count === 2).length >= 2;
        }

        function hasPair(rankCount) {
            return Object.values(rankCount).some(count => count === 2);
        }

        // 获取起始手牌代码
        function getStartingHandCode(card1, card2) {
            const ranks = 'AKQJT98765432';
            const rank1 = card1.rank;
            const rank2 = card2.rank;
            const suited = card1.suit === card2.suit ? 's' : 'o';
            
            // 对子
            if (rank1 === rank2) return rank1 + rank1;
            
            // 非对子
            const [highRank, lowRank] = ranks.indexOf(rank1) <= ranks.indexOf(rank2) 
                ? [rank1, rank2] 
                : [rank2, rank1];
                
            return highRank + lowRank + suited;
        }

        // 添加到原有的事件监听器中
        function addCardSelectionListeners() {
            const selectors = [
                'card1Rank', 'card1Suit', 'card2Rank', 'card2Suit',
                'flop1Rank', 'flop1Suit', 'flop2Rank', 'flop2Suit',
                'flop3Rank', 'flop3Suit', 'turnRank', 'turnSuit',
                'riverRank', 'riverSuit'
            ];
            
            selectors.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', () => {
                        const hand = getSelectedCards();
                        if (validateCardSelection(hand)) {
                            const equity = calculateHandStrength(hand);
                            updateWinRate(equity);
                        }
                    });
                }
            });
        }

        // 底池赔率计算
        function calculatePotOdds() {
            const potSize = parseFloat(document.getElementById('potSize').value) || 0;
            const betSize = parseFloat(document.getElementById('betSize').value) || 0;
            
            if (potSize >= 0 && betSize > 0) {
                const odds = potSize / betSize;
                const requiredEquity = (betSize / (potSize + betSize)) * 100;
                const roi = (potSize / betSize) * 100;
                
                // 显示结果区域
                const oddsResult = document.getElementById('oddsResult');
                oddsResult.style.display = 'block';
                
                // 更新结果
                document.getElementById('potOdds').textContent = odds.toFixed(1) + ' : 1';
                document.getElementById('requiredEquity').textContent = requiredEquity.toFixed(1) + '%';
                document.getElementById('roi').textContent = roi.toFixed(0) + '%';
            }
        }

        // 对手范围分析功能
        function analyzeOpponentRange() {
            const position = document.getElementById('opponentPosition').value;
            const action = document.getElementById('opponentAction').value;
            const street = document.getElementById('analyzeStreet').value;
            
            // 显示结果区域
            const rangeResult = document.getElementById('rangeAnalysisResult');
            rangeResult.style.display = 'block';
            
            // 根据位置和行动获取范围强度
            const strength = getRangeStrength(position, action);
            const hands = getKeyHands(position, action);
            const suggestion = getStrategySuggestion(strength, street);
            
            // 更新显示
            document.getElementById('rangeStrength').textContent = strength + '%';
            document.getElementById('keyHands').textContent = hands;
            document.getElementById('rangeSuggestion').textContent = suggestion;
        }

        function getRangeStrength(position, action) {
            // 简化的范围强度计算
            const strengthMap = {
                'UTG': { 'raise': 85, 'call': 70, '3bet': 90, '4bet': 95 },
                'MP': { 'raise': 80, 'call': 65, '3bet': 88, '4bet': 93 },
                'CO': { 'raise': 75, 'call': 60, '3bet': 85, '4bet': 92 },
                'BTN': { 'raise': 70, 'call': 55, '3bet': 82, '4bet': 90 },
                'SB': { 'raise': 65, 'call': 50, '3bet': 80, '4bet': 88 },
                'BB': { 'raise': 60, 'call': 45, '3bet': 78, '4bet': 85 }
            };
            return strengthMap[position][action] || 75;
        }

        function getKeyHands(position, action) {
            // 简化的关键牌型
            const handsMap = {
                'UTG': { 
                    'raise': 'AA-TT, AK-AQ', 
                    'call': 'JJ-99, AJ-AT', 
                    '3bet': 'AA-QQ, AK', 
                    '4bet': 'AA-KK, AKs' 
                },
                'MP': { 
                    'raise': 'AA-99, AK-AJ', 
                    'call': 'TT-88, AJ-AT', 
                    '3bet': 'AA-JJ, AK-AQ', 
                    '4bet': 'AA-QQ, AK' 
                }
                // ... 其他位置的牌型可以根据需要添加
            };
            return handsMap[position]?.[action] || 'AA-TT, AK';
        }

        function getStrategySuggestion(strength, street) {
            if (strength > 90) {
                return '对手范围非常强，建议谨慎行动';
            } else if (strength > 80) {
                return '对手范围较强，可以考虑防守性打法';
            } else if (strength > 70) {
                return '对手范围中等，可以尝试探测性下注';
            } else {
                return '对手范围较弱，可以考虑积极进攻';
            }
        }

        // 初始化图表
        let myChart = null;

        function createChart() {
            const ctx = document.getElementById('handTypeChart');
            
            // 如果已存在图表，先销毁
            if (myChart) {
                myChart.destroy();
            }

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['高牌', '一对', '两对', '三条', '顺子', '同花', '葫芦', '四条', '同花顺'],
                    datasets: [{
                        data: [50, 42.3, 4.75, 2.11, 0.392, 0.197, 0.144, 0.024, 0.00139],
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0',
                            '#9966FF',
                            '#FF9F40',
                            '#36A2EB',
                            '#4BC0C0',
                            '#9966FF'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // 修改初始化显示
        function initializeDisplay() {
            // 设置初始胜率为 0%
            document.getElementById('mainWinRate').textContent = '0%';
            
            // 设置进度条为 0
            const progressBars = document.querySelectorAll('.progress-fill');
            if (progressBars.length >= 3) {
                progressBars[0].style.width = '0%';
                progressBars[1].style.width = '0%';
                progressBars[2].style.width = '100%';
            }
            
            // 设置初始建议
            document.getElementById('suggestion').textContent = '请选择手牌';
            
            // 设置详细统计的初始值
            const statValues = document.querySelectorAll('.win-rate-details .stat-value');
            if (statValues.length >= 3) {
                statValues[0].textContent = '0%';
                statValues[1].textContent = '0%';
                statValues[2].textContent = '100%';
            }
        }

        // 修改页面加载函数
        window.onload = function() {
            // 初始化选择器
            initializeCardSelectors();
            
            // 初始化显示
            initializeDisplay();
            
            // 创建图表
            createChart();
            
            // 更新时间
            const now = new Date();
            document.getElementById('updateTime').textContent = now.toLocaleTimeString('zh-CN');
        };

        // 修改验证函数
        function validateCardSelection(hand) {
            // 如果没有选择手牌，返回 false
            if (!hand.hand[0].rank || !hand.hand[0].suit || 
                !hand.hand[1].rank || !hand.hand[1].suit) {
                return false;
            }

            // 收集所有已选择的牌
            const selectedCards = [];
            
            // 添加手牌
            selectedCards.push(hand.hand[0].rank + hand.hand[0].suit);
            selectedCards.push(hand.hand[1].rank + hand.hand[1].suit);
            
            // 添加公共牌
            hand.board.forEach(card => {
                if (card.rank && card.suit) {
                    selectedCards.push(card.rank + card.suit);
                }
            });

            // 检查重复
            const uniqueCards = new Set(selectedCards);
            return uniqueCards.size === selectedCards.length;
        }

        // 修改计算函数
        function calculateAndUpdateEquity() {
            const hand = getSelectedCards();
            console.log('Selected cards:', hand);
            
            // 检查是否有手牌
            if (!hand.hand[0].rank || !hand.hand[0].suit || 
                !hand.hand[1].rank || !hand.hand[1].suit) {
                console.log('No hole cards selected');
                document.getElementById('suggestion').textContent = '请选择手牌';
                return;
            }

            // 验证选择的牌
            if (!validateCardSelection(hand)) {
                console.log('Invalid card selection');
                document.getElementById('suggestion').textContent = '选择的牌有重复';
                return;
            }

            // 计算胜率
            const equity = calculateHandStrength(hand);
            console.log('Calculated equity:', equity);
            
            // 更新显示
            updateWinRate(equity);
            updateDetailedStats(hand);
            updateChart([equity]);
            saveToHistory(hand, equity);
        }

        // 修改选择器事件监听
        function initializeCardSelectors() {
            const ranks = ['A', 'K', 'Q', 'J', 'T', '9', '8', '7', '6', '5', '4', '3', '2'];
            const suits = [
                {value: 'h', text: '♥'},
                {value: 's', text: '♠'},
                {value: 'd', text: '♦'},
                {value: 'c', text: '♣'}
            ];

            // 所有选择器
            const allSelectors = {
                rank: [
                    'card1Rank', 'card2Rank',
                    'flop1Rank', 'flop2Rank', 'flop3Rank',
                    'turnRank', 'riverRank'
                ],
                suit: [
                    'card1Suit', 'card2Suit',
                    'flop1Suit', 'flop2Suit', 'flop3Suit',
                    'turnSuit', 'riverSuit'
                ]
            };

            // 初始化点数选择器
            allSelectors.rank.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '<option value="">点数</option>';
                    ranks.forEach(rank => {
                        const option = document.createElement('option');
                        option.value = rank;
                        option.text = rank === 'T' ? '10' : rank;
                        select.appendChild(option);
                    });
                    
                    // 添加事件监听器
                    select.addEventListener('change', function() {
                        console.log(`${id} changed to ${this.value}`);
                        calculateAndUpdateEquity();
                    });
                }
            });

            // 初始化花色选择器
            allSelectors.suit.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '<option value="">花色</option>';
                    suits.forEach(suit => {
                        const option = document.createElement('option');
                        option.value = suit.value;
                        option.text = suit.text;
                        select.appendChild(option);
                    });
                    
                    // 添加事件监听器
                    select.addEventListener('change', function() {
                        console.log(`${id} changed to ${this.value}`);
                        calculateAndUpdateEquity();
                    });
                }
            });
        }

        // 获取选择的牌
        function getSelectedCards() {
            const hand = {
                hand: [
                    {
                        rank: document.getElementById('card1Rank').value,
                        suit: document.getElementById('card1Suit').value
                    },
                    {
                        rank: document.getElementById('card2Rank').value,
                        suit: document.getElementById('card2Suit').value
                    }
                ],
                board: []
            };

            // 获取公共牌
            const boardCards = [
                {rank: 'flop1Rank', suit: 'flop1Suit'},
                {rank: 'flop2Rank', suit: 'flop2Suit'},
                {rank: 'flop3Rank', suit: 'flop3Suit'},
                {rank: 'turnRank', suit: 'turnSuit'},
                {rank: 'riverRank', suit: 'riverSuit'}
            ];

            boardCards.forEach(card => {
                const rank = document.getElementById(card.rank).value;
                const suit = document.getElementById(card.suit).value;
                if (rank && suit) {
                    hand.board.push({rank, suit});
                }
            });

            return hand;
        }

        // 更新胜率显示
        function updateWinRate(equity) {
            document.getElementById('mainWinRate').textContent = equity + '%';
            
            // 获取当前手牌分析
            const hand = getSelectedCards();
            const analysis = analyzeHandPossibilities(hand);
            
            // 更新建议区域，使用 pre 标签保持格式
            const suggestion = document.getElementById('suggestion');
            suggestion.innerHTML = `<pre>${analysis.suggestion}</pre>`;
            
            // 更新进度条
            const progressBars = document.querySelectorAll('.progress-fill');
            progressBars[0].style.width = equity + '%';
            progressBars[1].style.width = '0%';
            progressBars[2].style.width = (100 - equity) + '%';
            
            // 更新详细统计
            const statValues = document.querySelectorAll('.win-rate-details .stat-value');
            statValues[0].textContent = equity + '%';
            statValues[1].textContent = '0%';
            statValues[2].textContent = (100 - equity) + '%';
        }

        // 更新详细统计
        function updateDetailedStats(hand) {
            // 更新手牌分类统计
            const stats = calculateHandStats(hand);
            
            // 更新各个统计值
            Object.keys(stats).forEach(key => {
                const bar = document.getElementById(`${key}Bar`);
                const value = document.getElementById(`${key}Value`);
                if (bar && value) {
                    bar.style.width = stats[key] + '%';
                    value.textContent = stats[key] + '%';
                }
            });
        }

        // 计算手牌统计
        function calculateHandStats(hand) {
            const stats = {
                highCard: 0,
                pair: 0,
                connector: 0,
                suited: 0,
                straightDraw: 0,
                flushDraw: 0
            };

            // 根据手牌和公共牌计算各种统计
            // ... 具体计算逻辑 ...

            return stats;
        }

        // 历史记录数组
        let handHistory = [];

        // 保存当前手牌到历史记录
        function saveToHistory(hand, equity) {
            const timestamp = new Date().toLocaleString('zh-CN');
            const historyItem = {
                timestamp: timestamp,
                hand: hand,
                equity: equity,
                id: Date.now() // 唯一标识符
            };
            
            // 添加到历史记录
            handHistory.unshift(historyItem); // 新记录添加到开头
            
            // 限制历史记录数量（比如最多保存20条）
            if (handHistory.length > 20) {
                handHistory.pop();
            }
            
            // 保存到本地存储
            localStorage.setItem('pokerHandHistory', JSON.stringify(handHistory));
            
            // 更新显示
            updateHistoryDisplay();
        }

        // 更新历史记录显示
        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            if (!historyList) return;

            historyList.innerHTML = handHistory.map(item => `
                <div class="history-item" data-id="${item.id}">
                    <div class="history-header">
                        <span class="history-time">${item.timestamp}</span>
                        <span class="history-equity">胜率: ${item.equity}%</span>
                    </div>
                    <div class="history-cards">
                        <span class="hole-cards">
                            手牌: ${formatCard(item.hand.hand[0])} ${formatCard(item.hand.hand[1])}
                        </span>
                        ${item.hand.board.length > 0 ? `
                            <span class="board-cards">
                                公共牌: ${item.hand.board.map(formatCard).join(' ')}
                            </span>
                        ` : ''}
                    </div>
                    <div class="history-actions">
                        <button onclick="loadHistoryHand(${item.id})">加载</button>
                        <button onclick="deleteHistoryHand(${item.id})">删除</button>
                    </div>
                </div>
            `).join('');
        }

        // 格式化牌的显示
        function formatCard(card) {
            const suitSymbols = {
                'h': '♥',
                'd': '♦',
                'c': '♣',
                's': '♠'
            };
            return `${card.rank}${suitSymbols[card.suit]}`;
        }

        // 加载历史手牌
        function loadHistoryHand(id) {
            const historyItem = handHistory.find(item => item.id === id);
            if (!historyItem) return;

            // 设置手牌
            setCardSelectors('card1', historyItem.hand.hand[0]);
            setCardSelectors('card2', historyItem.hand.hand[1]);

            // 设置公共牌
            ['flop1', 'flop2', 'flop3', 'turn', 'river'].forEach((prefix, index) => {
                if (historyItem.hand.board[index]) {
                    setCardSelectors(prefix, historyItem.hand.board[index]);
                } else {
                    clearCardSelectors(prefix);
                }
            });

            // 重新计算胜率
            calculateAndUpdateEquity();
        }

        // 删除历史记录
        function deleteHistoryHand(id) {
            handHistory = handHistory.filter(item => item.id !== id);
            localStorage.setItem('pokerHandHistory', JSON.stringify(handHistory));
            updateHistoryDisplay();
        }

        // 设置牌选择器的值
        function setCardSelectors(prefix, card) {
            const rankSelector = document.getElementById(`${prefix}Rank`);
            const suitSelector = document.getElementById(`${prefix}Suit`);
            if (rankSelector && suitSelector) {
                rankSelector.value = card.rank;
                suitSelector.value = card.suit;
            }
        }

        // 清空牌选择器
        function clearCardSelectors(prefix) {
            const rankSelector = document.getElementById(`${prefix}Rank`);
            const suitSelector = document.getElementById(`${prefix}Suit`);
            if (rankSelector && suitSelector) {
                rankSelector.value = '';
                suitSelector.value = '';
            }
        }

        // 更新图表数据的函数
        function updateChartWithHand(hand) {
            if (!myChart) return;

            // 根据当前手牌计算概率
            const probabilities = calculateProbabilities(hand);
            
            // 更新图表数据
            myChart.data.datasets[0].data = [
                probabilities.highCard,
                probabilities.pair,
                probabilities.twoPair,
                probabilities.threeOfAKind,
                probabilities.straight,
                probabilities.flush,
                probabilities.fullHouse,
                probabilities.fourOfAKind,
                probabilities.straightFlush
            ];
            
            myChart.update();
        }

        // 计算牌型概率
        function calculateProbabilities(hand) {
            // 基础概率
            let probs = {
                highCard: 50,
                pair: 42.3,
                twoPair: 4.75,
                threeOfAKind: 2.11,
                straight: 0.392,
                flush: 0.197,
                fullHouse: 0.144,
                fourOfAKind: 0.024,
                straightFlush: 0.00139
            };

            if (!hand || !hand.hand || !hand.hand[0].rank) {
                return probs;
            }

            // 根据手牌调整概率
            const card1 = hand.hand[0];
            const card2 = hand.hand[1];

            // 如果是对子
            if (card1.rank === card2.rank) {
                probs.pair = 100;
                probs.highCard = 0;
                probs.twoPair *= 2;
                probs.threeOfAKind *= 3;
                probs.fullHouse *= 2;
            }

            // 如果是同花
            if (card1.suit === card2.suit) {
                probs.flush *= 3;
                probs.straightFlush *= 2;
            }

            // 如果是连牌
            const ranks = 'A23456789TJQKA';
            const gap = Math.abs(ranks.indexOf(card1.rank) - ranks.indexOf(card2.rank));
            if (gap <= 4) {
                probs.straight *= 2;
                if (card1.suit === card2.suit) {
                    probs.straightFlush *= 3;
                }
            }

            // 如果有公共牌，进一步调整概率
            if (hand.board && hand.board.length > 0) {
                adjustProbabilitiesWithBoard(probs, hand);
            }

            return probs;
        }

        // 根据公共牌调整概率
        function adjustProbabilitiesWithBoard(probs, hand) {
            const allCards = [...hand.hand, ...hand.board];
            
            // 统计点数和花色
            const rankCount = {};
            const suitCount = {};
            
            allCards.forEach(card => {
                rankCount[card.rank] = (rankCount[card.rank] || 0) + 1;
                suitCount[card.suit] = (suitCount[card.suit] || 0) + 1;
            });

            // 根据已有牌型调整概率
            const maxRankCount = Math.max(...Object.values(rankCount));
            const maxSuitCount = Math.max(...Object.values(suitCount));

            // 调整对子相关概率
            if (maxRankCount >= 2) {
                probs.pair = 100;
                probs.highCard = 0;
                probs.twoPair *= 2;
                probs.threeOfAKind *= 1.5;
            }
            if (maxRankCount >= 3) {
                probs.threeOfAKind = 100;
                probs.fullHouse *= 3;
            }
            if (maxRankCount >= 4) {
                probs.fourOfAKind = 100;
            }

            // 调整同花相关概率
            if (maxSuitCount >= 3) {
                probs.flush *= 3;
            }
            if (maxSuitCount >= 4) {
                probs.flush *= 5;
                probs.straightFlush *= 2;
            }
        }

        // 分析当前可能的牌型
        function analyzeHandPossibilities(hand) {
            let analysis = {
                currentHand: '高牌',
                possibleHands: [],
                suggestion: ''
            };

            // 获取所有当前牌
            const allCards = [...hand.hand, ...hand.board];
            
            // 统计点数和花色
            const rankCount = {};
            const suitCount = {};
            allCards.forEach(card => {
                rankCount[card.rank] = (rankCount[card.rank] || 0) + 1;
                suitCount[card.suit] = (suitCount[card.suit] || 0) + 1;
            });

            // 分析当前牌型
            if (hasStraightFlush(allCards)) analysis.currentHand = '同花顺';
            else if (hasFourOfAKind(rankCount)) analysis.currentHand = '四条';
            else if (hasFullHouse(rankCount)) analysis.currentHand = '葫芦';
            else if (hasFlush(suitCount)) analysis.currentHand = '同花';
            else if (hasStraight(allCards)) analysis.currentHand = '顺子';
            else if (hasThreeOfAKind(rankCount)) analysis.currentHand = '三条';
            else if (hasTwoPair(rankCount)) analysis.currentHand = '两对';
            else if (hasPair(rankCount)) analysis.currentHand = '一对';

            // 分析潜在牌型
            analysis.possibleHands = analyzePotentialHands(hand, rankCount, suitCount);

            // 生成建议
            analysis.suggestion = generateHandAdvice(analysis.currentHand, analysis.possibleHands);

            return analysis;
        }

        // 分析潜在牌型
        function analyzePotentialHands(hand, rankCount, suitCount) {
            const possibilities = [];
            const allCards = [...hand.hand, ...hand.board];

            // 检查同花潜力
            Object.entries(suitCount).forEach(([suit, count]) => {
                if (count >= 4) {
                    possibilities.push('差一张同花');
                } else if (count === 3 && hand.board.length <= 3) {
                    possibilities.push('同花听牌');
                }
            });

            // 检查顺子潜力
            const ranks = 'A23456789TJQKA';
            const distinctRanks = [...new Set(allCards.map(c => c.rank))].sort(
                (a, b) => ranks.indexOf(a) - ranks.indexOf(b)
            );
            
            // 检查顺子差距
            for (let i = 0; i < distinctRanks.length - 3; i++) {
                const segment = distinctRanks.slice(i, i + 4);
                if (segment.length === 4 && 
                    ranks.indexOf(segment[segment.length-1]) - 
                    ranks.indexOf(segment[0]) <= 4) {
                    possibilities.push('顺子听牌');
                    break;
                }
            }

            // 检查对子升级潜力
            if (Object.values(rankCount).includes(2)) {
                possibilities.push('可能升级到三条');
                if (Object.values(rankCount).filter(count => count === 2).length === 1) {
                    possibilities.push('可能形成两对');
                }
            }

            return possibilities;
        }

        // 生成建议
        function generateHandAdvice(currentHand, possibilities) {
            let advice = `当前牌型：${currentHand}\n`;
            
            if (possibilities.length > 0) {
                advice += '潜在改善：\n';
                possibilities.forEach(p => {
                    advice += `- ${p}\n`;
                });
            }

            // 根据牌型和潜力给出建议
            switch (currentHand) {
                case '同花顺':
                case '四条':
                    advice += '\n建议：强力加注';
                    break;
                case '葫芦':
                case '同花':
                    advice += '\n建议：可以考虑加注';
                    break;
                case '顺子':
                case '三条':
                    if (possibilities.length > 0) {
                        advice += '\n建议：适度加注，注意潜在改善';
                    } else {
                        advice += '\n建议：谨慎加注';
                    }
                    break;
                case '两对':
                    if (possibilities.includes('可能升级到三条') || 
                        possibilities.includes('同花听牌')) {
                        advice += '\n建议：可以跟注，留意改善机会';
                    } else {
                        advice += '\n建议：谨慎行动';
                    }
                    break;
                default:
                    if (possibilities.length > 0) {
                        advice += '\n建议：观察形势，等待改善';
                    } else {
                        advice += '\n建议：考虑弃牌';
                    }
            }

            return advice;
        }
    </script>
</body>
</html> 
